package main

import (
	"crypto/sha256"
	"encoding/xml"
	"fmt"
	"log"
	"os"
	"strings"

	"github.com/apixu/apixu-go/v2"
	"github.com/apixu/apixu-go/v2/response"
)

const idHashKey = "secretkey"

// MyApixuAPI defines an extension of Apixu API
type MyApixuAPI struct {
	apixu.Apixu
}

// MyConditions defines the custom Conditions list
type MyConditions []MyCondition

// MarshalXML handles formats XML string
func (c MyConditions) MarshalXML(e *xml.Encoder, start xml.StartElement) error {
	res := struct {
		Items []MyCondition `xml:"condition"`
	}{Items: c}

	start.Name = xml.Name{
		Local: "MyConditionsList",
	}

	return e.EncodeElement(res, start)
}

// MyCondition defines the custom weather condition item
type MyCondition struct {
	// Embed main Conditions response
	response.Condition

	// Add a new field
	ID string `json:"id" xml:"id"`

	// Overwrite existing field to hide it from xml and json representations
	Code int `json:"code,omitempty" xml:"code,omitempty"`
}

// Conditions retrieves the weather conditions list and adds extra information
func (a *MyApixuAPI) Conditions() (res MyConditions, err error) {
	conditions, err := a.Apixu.Conditions()

	for _, c := range conditions {
		c.Day = strings.ToUpper(c.Day)

		sha := sha256.New()
		if _, e := sha.Write([]byte(fmt.Sprintf("%d.%s", c.Code, idHashKey))); e != nil {
			return res, e
		}
		id := fmt.Sprintf("%x", sha.Sum(nil))

		cond := MyCondition{
			Condition: c,
			ID:        id,
			Code:      c.Code,
		}
		res = append(res, cond)
	}
	return
}

func main() {
	config := apixu.Config{
		APIKey: os.Getenv("APIXUKEY"),
	}

	a, err := apixu.New(config)
	if err != nil {
		log.Fatal(err)
	}

	// Create custom API instance
	myApixuAPI := &MyApixuAPI{a}

	// Call overwritten method
	conditions, err := myApixuAPI.Conditions()

	if err != nil {
		if e, ok := err.(*apixu.Error); ok {
			log.Fatal(e.Error(), e.Response().Code, e.Response().Message)
		}
		log.Fatal(err)
	}

	b, err := xml.Marshal(conditions)
	if err != nil {
		log.Fatal(err)
	}

	fmt.Printf("%s\n\n", b)

	for _, c := range conditions {
		fmt.Println("\tCode:", c.Code)
		fmt.Println("\tDay:", c.Day)
		fmt.Println("\tNight:", c.Night)
		fmt.Println("\tIcon:", c.Icon)
		fmt.Println("\tID:", c.ID)
		fmt.Println()
	}

	// Call existing method
	q := "Kolno"
	search, err := myApixuAPI.Search(q)

	if err != nil {
		if e, ok := err.(*apixu.Error); ok {
			log.Fatal(e.Error(), e.Response().Code, e.Response().Message)
		}
		log.Fatal(err)
	}

	for _, item := range search {
		fmt.Println("\tID:", item.ID)
		fmt.Println("\tName:", item.Name)
		fmt.Println("\tRegion:", item.Region)
		fmt.Println("\tCountry:", item.Country)
		fmt.Println("\tLat:", item.Lat)
		fmt.Println("\tLon:", item.Lon)
		fmt.Println("\tURL:", item.URL)
		fmt.Println()
	}

	data, err := xml.Marshal(search)
	if err != nil {
		log.Fatal(err)
	}
	fmt.Printf("\n%s", data)
}
